<app-header />

@if(articleLoading){
    <div class="d-flex flex-column justify-content-center align-items-center m-5">
        <mat-spinner mode="indeterminate"></mat-spinner>
    </div>
}

@else {
    @if(postNotFoundError()){
<div class="alert alert-danger m-5">
    {{postNotFoundError()}}
</div>
}
@else if (errorMsg()) {
<div class="alert alert-danger m-5">
    {{errorMsg()}}
</div>
}
@else {
<div class="container mt-4">
    <mat-card>
        <mat-card-header class="d-flex flex-column align-items-center justify-content-center">
            <mat-card-title class="my-3">Modifier l'article</mat-card-title>
            @if(successMsg()){
                <div class="alert alert-success m-3 d-flex">
                    {{successMsg()}}
                </div>
            }
        </mat-card-header>
        <mat-card-content>
            <form [formGroup]="editPostForm" (ngSubmit)="onSubmit()">
                <mat-form-field appearance="outline" class="w-100 mb-3">
                    <mat-label>Titre</mat-label>
                    <input matInput formControlName="title" required>
                    <mat-error *ngIf="editPostForm.get('title')?.invalid && editPostForm.get('title')?.touched">
                        Le titre est requis.
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-100 mb-3">
                    <mat-label>Slug (URL conviviale)</mat-label>
                    <input matInput formControlName="slug" required readonly>
                    <!-- Slug should be readonly in edit mode -->
                    <mat-error *ngIf="editPostForm.get('slug')?.invalid && editPostForm.get('slug')?.touched">
                        Le slug est requis.
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-100 mb-3">
                    <mat-label>Description (résumé)</mat-label>
                    <textarea matInput formControlName="description" rows="3" required></textarea>
                    @if(editPostForm.get('description')?.invalid && editPostForm.get('description')?.touched){
                    <mat-error>
                        La description est requise.
                    </mat-error>
                    }
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-100 mb-3">
                    <mat-label>Image actuelle(URL)</mat-label>
                    <input matInput type="text" formControlName="postImg">
                </mat-form-field>

                <div class="w-100 mb-3">
                    <app-image-upload [imgUrlControl]="editPostForm.get('postImg')" />
                </div>

                <app-editor innerValue="editPostForm.get('content')" formControlName="content"
                    label="Contenu de l'article" />

                @if(editPostForm.get('content')?.invalid && editPostForm.get('content')?.touched){
                <div class="alert alert-danger">
                    Le contenu est requis.
                </div>
                }

                <mat-form-field appearance="outline" class="w-100 my-4">
                    <mat-label>Tags</mat-label>
                    <mat-chip-grid #chipGrid aria-label="Tags de l'article">
                        @for(tag of selectedTags; track $index){
                        <mat-chip-row (removed)="removeTag(tag)">
                            {{ tag }}
                            <button matChipRemove [attr.aria-label]="'remove ' + tag">
                                <mat-icon>cancel</mat-icon>
                            </button>
                        </mat-chip-row>
                        }

                    </mat-chip-grid>
                    <input placeholder="Ajouter un tag..." #tagInput [formControl]="tagCtrl"
                        [matChipInputFor]="chipGrid" [matAutocomplete]="auto"
                        (matChipInputTokenEnd)="addTagFromInput($event)">
                    <mat-autocomplete #auto="matAutocomplete" (optionSelected)="selected($event)">
                        <mat-option *ngFor="let tag of filteredTags | async" [value]="tag">
                            {{ tag }}
                        </mat-option>
                    </mat-autocomplete>
                </mat-form-field>

                <div class="d-flex justify-content-end align-items-center flex-wrap">
                    <button mat-raised-button color="primary" type="submit" [disabled]="editPostForm.invalid || loader"
                        class="me-2 my-1">
                        @if(loader){
                        <mat-spinner diameter="20"></mat-spinner>
                        } @else { Mettre à jour }
                    </button>
                    @if (post && post.draft) {
                    <button mat-raised-button color="accent" (click)="onPublishDraft()"
                        [disabled]="editPostForm.invalid || publishLoader" class="me-2 my-1">
                        @if(publishLoader){
                        <mat-spinner diameter="20"></mat-spinner>
                        } @else { Publier l'article }
                    </button>
                    }
                    @if (post && post.published) {
                    <button mat-raised-button color="warn" (click)="unpublishPost()" [disabled]="unpublishLoader"
                        class="me-2 my-1">
                        @if(unpublishLoader){
                        <mat-spinner diameter="20"></mat-spinner>
                        } @else { Dépublier l'article }
                    </button>
                    }
                    <button mat-raised-button type="button" (click)="onCancel()" class="me-2 my-1">
                        Annuler
                    </button>
                </div>
            </form>
        </mat-card-content>
    </mat-card>
</div>
}
}
